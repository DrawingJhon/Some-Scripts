local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local CAS = game:GetService("ContextActionService")

local LocalPlayer = Players.LocalPlayer
local Character = LocalPlayer.Character
local RootPart = Character.HumanoidRootPart
local Humanoid: Humanoid = Character.Humanoid

local DOWN_ACTION_NAME = "DownCarpet"

local function StartLoop(func)
	task.spawn(func, 0)
	
	return RunService.Heartbeat:Connect(func)
end

local Tool = Instance.new("Tool")
Tool.Name = "Carpet Fly"
Tool.RequiresHandle = false
Tool.CanBeDropped = false

local flyLoop = nil
local bv, bg

Tool.Equipped:Connect(function()
	bv = Instance.new("BodyPosition")
	bv.D = 900
	bv.MaxForce = Vector3.one * math.huge
	bv.Position = RootPart.Position
	bv.Parent = RootPart
	
	--[[bv = Instance.new("BodyVelocity")
	bv.MaxForce = Vector3.one * math.huge
	bv.Velocity = Vector3.zero
	bv.Parent = RootPart]]
	
	bg = Instance.new("BodyGyro")
	bg.MaxTorque = Vector3.one * math.huge
	bg.CFrame = CFrame.Angles(math.rad(-90), 0, 0)
	bg.Parent = RootPart
	
	local verticalSpeed = 6
	local horizontalSpeed = 10
	
	local pressingDown = false
	
	flyLoop = StartLoop(function(deltaTime)
		Humanoid.PlatformStand = true
		
		local yVel = (Humanoid.Jump and 1 or 0) - (pressingDown and 1 or 0)
		
		local verticalVelocity = Vector3.new(0, yVel, 0) * verticalSpeed
		local horizontalVelocity = Humanoid.MoveDirection * horizontalSpeed
		
		--bv.Velocity = bv.Velocity:Lerp(verticalVelocity + horizontalVelocity, math.min(6 * deltaTime, 1))
		bv.Position += (verticalVelocity + horizontalVelocity) * deltaTime
	end)
	
	CAS:BindAction(DOWN_ACTION_NAME, function(actionName, inputState)
		if inputState == Enum.UserInputState.Begin then
			pressingDown = true
		elseif inputState == Enum.UserInputState.End then
			pressingDown = false
		end
	end, true, Enum.KeyCode.Q)
end)

Tool.Unequipped:Connect(function()
	bv:Destroy()
	bg:Destroy()
	flyLoop:Disconnect()
	
	CAS:UnbindAction(DOWN_ACTION_NAME)
	
	RootPart.CFrame = CFrame.new(RootPart.Position)
	Humanoid.PlatformStand = false
end)

Tool.Parent = LocalPlayer.Backpack
